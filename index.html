<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Barcode Inventory Tracker</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: auto;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #logo {
      height: 48px;
    }
    label {
      display: block;
      margin-top: 12px;
      font-weight: bold;
    }
    input, select {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      font-size: 1em;
    }
    button {
      padding: 10px;
      margin-top: 12px;
      cursor: pointer;
    }
    #form-container { display: none; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 25px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    #metalButtons button {
      margin: 5px 10px 5px 0;
      padding: 8px 14px;
    }
    #metalButtons button.active {
      background-color: #007bff;
      color: white;
    }
    #reader {
      margin-top: 10px;
      width: 100%;
      max-width: 400px;
      display: none;
    }
    video {
      width: 100%;
      max-width: 400px;
    }

    /* Delete button styles */
  .delete-btn {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 1.3em;   /* slightly bigger for clarity */
  color: #d22;        /* bright red */
  padding: 4px 8px;
  border-radius: 2px;
  transition: color 0.3s ease;
}

.delete-btn:hover {
  color: #a00; /* darker red on hover */
}

  </style>
</head>
<body>

<header>
  <h2>Inventory Tracker</h2>
  <img src="Rea-logo.png" id="logo" alt="Logo">
</header>

<div id="login-container">
  <form onsubmit="event.preventDefault(); login();">
    <label for="username">Enter Your Name:</label>
    <input type="text" id="username" />
    <button type="submit">Login</button>
  </form>
</div>

<div id="form-container">
  <p><strong>User:</strong> <span id="currentUser"></span></p>

  <label for="barcode">Scan or Enter Barcode:</label>
  <input type="text" id="barcode" />
  <button type="button" onclick="startCamera()">📷 Start Scanner</button>
  <button type="button" onclick="flipCamera()">🔄 Flip Camera</button>
  <div id="reader">
    <video id="video" autoplay playsinline muted></video>
  </div>

  <label>Metal Type:</label>
  <div id="metalButtons">
    <button type="button" onclick="setMetal(this, 'Aluminum')">Aluminum</button>
    <button type="button" onclick="setMetal(this, 'Alloy')">Alloy</button>
    <button type="button" onclick="setMetal(this, 'Copper')">Copper</button>
    <button type="button" onclick="setMetal(this, 'Brass')">Brass</button>
  </div>

  <label for="weight">Weight (lbs):</label>
  <input type="number" id="weight" step="0.01" />

  <label for="location">Location:</label>
  <select id="location" onchange="setLocation(this.value)">
    <option value="">--Choose--</option>
    <option value="Building 5">Building 5</option>
  </select>

  <button onclick="submitEntry()">Submit</button>

  <table id="logTable">
    <thead>
      <tr>
        <th>Timestamp</th>
        <th>User</th>
        <th>Barcode</th>
        <th>Weight</th>
        <th>Metal</th>
        <th>Location</th>
        <!-- No action header -->
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button onclick="exportToExcel()">Export to Excel</button>
</div>

<!-- SheetJS CDN -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script>
  let currentUser = '';
  let selectedMetal = '';
  let currentLocation = '';
  const dataLog = [];
  let cameraStream;
  let facingMode = 'environment';

  function login() {
    const name = document.getElementById("username").value.trim();
    if (!name) return alert("Enter your name.");
    currentUser = name;
    document.getElementById("currentUser").innerText = name;
    document.getElementById("login-container").style.display = "none";
    document.getElementById("form-container").style.display = "block";
  }

  function setMetal(button, metal) {
    selectedMetal = metal;
    document.querySelectorAll('#metalButtons button').forEach(btn => btn.classList.remove('active'));
    button.classList.add('active');
  }

  function setLocation(val) {
    currentLocation = val;
  }

  function submitEntry() {
    const barcode = document.getElementById("barcode").value.trim();
    const weight = document.getElementById("weight").value.trim();
    if (!weight || !selectedMetal || !currentLocation) {
      alert("Fill in all fields (except barcode is optional).");
      return;
    }
    const row = [new Date().toISOString(), currentUser, barcode, weight, selectedMetal, currentLocation];
    dataLog.push(row);
    appendRow(row);
    document.getElementById("barcode").value = '';
    document.getElementById("weight").value = '';
  }

  function appendRow(row) {
    const tr = document.createElement("tr");
    row.forEach(cell => {
      const td = document.createElement("td");
      td.innerText = cell;
      tr.appendChild(td);
    });

    const tdDelete = document.createElement("td");
    const btnDelete = document.createElement("button");
    btnDelete.className = "delete-btn";
    btnDelete.title = "Delete entry";
    btnDelete.innerHTML = "🗑️";
    btnDelete.onclick = () => {
      tr.remove();
      const index = dataLog.indexOf(row);
      if (index > -1) dataLog.splice(index, 1);
    };
    tdDelete.appendChild(btnDelete);
    tr.appendChild(tdDelete);

    document.querySelector("#logTable tbody").appendChild(tr);
  }

  async function startCamera() {
    try {
      const video = document.getElementById("video");
      if (cameraStream) {
        cameraStream.getTracks().forEach(t => t.stop());
      }

      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: facingMode }
      });
      cameraStream = stream;
      video.srcObject = stream;
      document.getElementById("reader").style.display = "block";
      video.play();

      if (!("BarcodeDetector" in window)) {
        alert("BarcodeDetector API not supported in this browser.");
        return;
      }

      const detector = new BarcodeDetector({ formats: ["code_128", "ean_13", "qr_code"] });
      scanLoop(detector, video);
    } catch (e) {
      alert("Camera error: " + e.message);
      console.error(e);
    }
  }

  function flipCamera() {
    facingMode = (facingMode === "environment") ? "user" : "environment";
    startCamera();
  }

  function scanLoop(detector, video) {
    detector.detect(video)
      .then(codes => {
        codes.forEach(code => {
          const text = code.rawValue;
          document.getElementById("barcode").value = text;
          extractWeight(text);
        });
      })
      .catch(err => {
        console.error("Detect error:", err);
      })
      .finally(() => {
        requestAnimationFrame(() => scanLoop(detector, video));
      });
  }

  function extractWeight(barcode) {
    const match = barcode.match(/^Q(\d{3,4}(\.\d{1,2})?)$/);
    if (match) {
      const weightStr = match[1];
      document.getElementById("weight").value = parseFloat(weightStr);
    }
  }

  document.getElementById("barcode").addEventListener("input", () => {
    const val = document.getElementById("barcode").value.trim();
    extractWeight(val);
  });

  function exportToExcel() {
    if (dataLog.length === 0) {
      alert("No data to export!");
      return;
    }

    // Prepare data array with headers
    const exportData = [
      ["Timestamp", "User", "Barcode", "Weight", "Metal", "Location"]
    ].concat(dataLog);

    // Create worksheet
    const ws = XLSX.utils.aoa_to_sheet(exportData);
    // Create workbook and append worksheet
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Inventory");

    // Export as Excel file
    XLSX.writeFile(wb, `Inventory_${new Date().toISOString().slice(0,10)}.xlsx`);
  }
</script>

</body>
</html>
